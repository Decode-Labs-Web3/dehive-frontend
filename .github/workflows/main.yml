name: CI/CD

on:
	push:
		branches: [ main ]
	workflow_dispatch:

concurrency:
	group: ${{ github.workflow }}-${{ github.ref }}
	cancel-in-progress: true

env:
	NODE_VERSION: '20.x'
	REMOTE_DIR: /var/www/dehive-frontend
	NEXT_TELEMETRY_DISABLED: '1'

jobs:
	build:
		name: Build Next.js
		runs-on: ubuntu-latest
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Setup Node
				uses: actions/setup-node@v4
				with:
					node-version: ${{ env.NODE_VERSION }}
					cache: npm

			- name: Install dependencies
				run: |
					if [ -f package-lock.json ]; then
						npm ci
					else
						npm install
					fi

			- name: Type check
				run: npm run type-check --if-present

			- name: Lint
				run: npm run lint --if-present || true

			- name: Build
				run: npm run build

			- name: Prune dev dependencies
				run: npm prune --omit=dev

			- name: Prepare deploy bundle
				run: |
					mkdir -p deploy
					cp -R .next deploy/.next
					cp -R public deploy/public
					cp package.json deploy/package.json
					if [ -f package-lock.json ]; then cp package-lock.json deploy/package-lock.json; fi
					# Copy Next.js config if present
					if [ -f next.config.js ]; then cp next.config.js deploy/; fi
					if [ -f next.config.mjs ]; then cp next.config.mjs deploy/; fi
					if [ -f next.config.ts ]; then cp next.config.ts deploy/; fi
					# Include node_modules for runtime
					cp -R node_modules deploy/node_modules

			- name: Upload artifact
				uses: actions/upload-artifact@v4
				with:
					name: nextjs-build
					path: deploy
					if-no-files-found: error

	deploy:
		name: Deploy to Server
		needs: build
		if: github.ref == 'refs/heads/main'
		runs-on: ubuntu-latest
		steps:
			- name: Download artifact
				uses: actions/download-artifact@v4
				with:
					name: nextjs-build
					path: artifact

			- name: Copy files to server
				uses: appleboy/scp-action@v0.1.7
				with:
					host: ${{ secrets.SSH_HOST }}
					username: ${{ secrets.SSH_USER }}
					key: ${{ secrets.SSH_PRIVATE_KEY }}
					source: "artifact/*"
					target: ${{ env.REMOTE_DIR }}
					overwrite: true

			- name: Restart app via PM2
				uses: appleboy/ssh-action@v1.2.1
				with:
					host: ${{ secrets.SSH_HOST }}
					username: ${{ secrets.SSH_USER }}
					key: ${{ secrets.SSH_PRIVATE_KEY }}
					script: |
						set -e
						export NEXT_TELEMETRY_DISABLED=1
						APP_DIR="${{ env.REMOTE_DIR }}"
						mkdir -p "$APP_DIR"
						cd "$APP_DIR"
						# Ensure PM2 exists
						if ! command -v pm2 >/dev/null 2>&1; then
							npm i -g pm2
						fi
						# Start or restart the app
						if pm2 describe dehive-frontend >/dev/null 2>&1; then
							pm2 restart dehive-frontend
						else
							pm2 start npm --name "dehive-frontend" -- run start
						fi
						pm2 save
